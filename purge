#!/bin/bash

set -e

# -------- CONFIG --------
LAN_INTERFACE="eth0"
VPN_INTERFACE="wg0"
VPN_NETWORK="192.168.5.0/24"
VPN_PORT=51820
KEY_DIR="/etc/wireguard/keys"
WG_CONF="/etc/wireguard/${VPN_INTERFACE}.conf"
# ------------------------

echo "[!] ATTENTION : Ce script va supprimer toutes les configurations liées au VPN Proxy WireGuard."
read -p "Continuer ? (y/N): " confirm
[[ "$confirm" != "y" && "$confirm" != "Y" ]] && echo "Annulé." && exit 1

echo "[+] Arrêt du service WireGuard"
systemctl stop wg-quick@${VPN_INTERFACE} || true
systemctl disable wg-quick@${VPN_INTERFACE} || true

echo "[+] Suppression du fichier de configuration WireGuard"
rm -f "${WG_CONF}"

echo "[+] Suppression des clés WireGuard"
rm -rf "${KEY_DIR}"

echo "[+] Suppression des règles iptables"
iptables -D FORWARD -i ${VPN_INTERFACE} -j ACCEPT || true
iptables -D FORWARD -o ${VPN_INTERFACE} -j ACCEPT || true
iptables -t nat -D POSTROUTING -s ${VPN_NETWORK} -o ${LAN_INTERFACE} -j MASQUERADE || true
iptables -D FORWARD -i ${VPN_INTERFACE} -d 192.168.0.0/16 -j REJECT || true

echo "[+] Nettoyage des règles UFW (NAT)"
sed -i "/-A POSTROUTING -s ${VPN_NETWORK//\//\\/} -o ${LAN_INTERFACE} -j MASQUERADE/d" /etc/ufw/before.rules
sed -i '/\*nat/,/COMMIT/d' /etc/ufw/before.rules

echo "[+] Suppression de la règle UFW pour WireGuard"
ufw delete allow ${VPN_PORT}/udp || true

echo "[+] Réinitialisation UFW"
ufw --force reset

echo "[+] Réinstallation des valeurs par défaut dans /etc/network/interfaces"
cat <<EOF > /etc/network/interfaces
auto lo
iface lo inet loopback

auto ${LAN_INTERFACE}
iface ${LAN_INTERFACE} inet dhcp
EOF

echo "[+] Redémarrage du réseau"
systemctl restart networking || true

echo "[+] Suppression des paquets installés"
apt purge -y wireguard ufw iptables-persistent fail2ban haproxy
apt autoremove -y
apt clean

echo "[+] Suppression des fichiers restants"
rm -rf /etc/wireguard
rm -f /etc/iptables/rules.v4
rm -f /etc/iptables/rules.v6
rm -rf /var/log/fail2ban
rm -rf /etc/fail2ban

echo "[+] Réactivation des règles par défaut"
sed -i '/^net.ipv4.ip_forward/s/1/0/' /etc/sysctl.conf
echo 0 > /proc/sys/net/ipv4/ip_forward

echo ""
echo "✅ PURGE TERMINÉE"
echo "Le système est revenu à l'état initial. Le VPN proxy a été supprimé."

# 10. Ajout du bash mère.
wget -qO- https://raw.githubusercontent.com/ShuNeko/proxy-setup/refs/heads/main/setup> start.sh
chmod +x ./start.sh

# 11. Auto-suppression
echo "[*] Script terminé. Suppression de lui-même..."
rm -- "$0"
