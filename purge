#!/bin/bash

set -e

echo "[*] Lancement du script de purge totale (WireGuard, UFW, iptables, HAProxy)..."

# 1. Stopper services
systemctl stop ufw.service wg-quick@wg0.service haproxy 2>/dev/null || true
systemctl stop system-wg\x2dquick.slice 2>/dev/null || true

# 2. Désactiver les services
systemctl disable ufw.service wg-quick@wg0.service haproxy 2>/dev/null || true

# 3. Purge des paquets
apt-get purge -y wireguard wireguard-tools wireguard-dkms linux-headers-$(uname -r)
apt-get purge -y ufw iptables iptables-persistent netfilter-persistent
apt-get purge -y haproxy
apt-get autoremove --purge -y
apt-get clean

# 4. Suppression de fichiers de configuration et de services
rm -rf /etc/wireguard /usr/src/wireguard* /var/log/wireguard*
rm -f /etc/systemd/system/wg-quick@*.service /lib/systemd/system/wg-quick@*.service
rm -rf /etc/ufw /lib/ufw /etc/default/ufw /etc/init.d/ufw /var/log/ufw*
rm -rf /etc/iptables /etc/iptables-up.rules /etc/network/if-pre-up.d/iptables
rm -rf /etc/iptables/rules.v4 /etc/iptables/rules.v6
rm -f /etc/systemd/system/netfilter-persistent.service /lib/systemd/system/netfilter-persistent.service

rm -rf /etc/haproxy /var/lib/haproxy /var/log/haproxy*
rm -f /etc/default/haproxy /etc/init.d/haproxy
rm -f /etc/systemd/system/haproxy.service /lib/systemd/system/haproxy.service

# 5. Réinitialisation des règles iptables
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X
iptables -t raw -F
iptables -t raw -X
iptables -t security -F
iptables -t security -X

# 6. Suppression des slices et unités résiduelles
rm -rf /etc/systemd/system/system-wg\x2dquick.slice
rm -rf /run/systemd/system/system-wg\x2dquick.slice
rm -rf /run/systemd/generator/*
rm -rf /var/log/journal/*

# 7. Rechargement de systemd
systemctl daemon-reexec
systemctl daemon-reload
systemctl reset-failed

# 8. Suppression journaux
journalctl --rotate
journalctl --vacuum-time=1s --quiet
systemctl restart systemd-journald

# 9. Suppressions du add
rm ./add.sh

# 10. Ajout du bash mère.
wget -qO- https://raw.githubusercontent.com/ShuNeko/proxy-setup/refs/heads/main/init> start.sh
chmod +x ./start.sh

# 11. Auto-suppression
echo "[*] Script terminé. Suppression de lui-même..."
rm -- "$0"
