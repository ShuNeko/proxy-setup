#!/bin/bash

set -e

# -------- CONFIG --------
LAN_INTERFACE="eth0"
VPN_INTERFACE="wg0"
VPN_NETWORK="192.168.5.0/24"
KEY_DIR="/etc/wireguard/keys"
WG_CONF="/etc/wireguard/${VPN_INTERFACE}.conf"
HA_PROXY_CONF="/etc/haproxy/haproxy.cfg"
IPTABLES_SAVE_PATH="/etc/iptables/rules.save"
# ------------------------

save_iptables() {
    iptables-save > "$IPTABLES_SAVE_PATH"
}

restore_iptables() {
    if [ -f "$IPTABLES_SAVE_PATH" ]; then
        echo "[+] Restauration des règles iptables depuis $IPTABLES_SAVE_PATH"
        iptables-restore < "$IPTABLES_SAVE_PATH"
    else
        echo "[-] Fichier de sauvegarde des règles iptables non trouvé : $IPTABLES_SAVE_PATH"
    fi
}

add_wireguard_client() {
    read -p "Entrez le titre du serveur : " SERVER_TITLE
    read -p "Entrez la clé publique du client : " CLIENT_PUB_KEY
    read -p "Entrez l'IP attribuée au client (ex: 192.168.5.2) : " CLIENT_IP

    echo "[+] Ajout du client WireGuard"
    systemctl stop wg-quick@${VPN_INTERFACE}

    cat <<EOF >> "$WG_CONF"

# ${SERVER_TITLE}
[Peer]
PublicKey = $CLIENT_PUB_KEY
AllowedIPs = ${CLIENT_IP}/32
EOF

    systemctl start wg-quick@${VPN_INTERFACE}
}

configure_iptables() {
    read -p "Voulez-vous cloisonner le serveur ? (y/n) : " CLOISON
    read -p "Voulez-vous utiliser le load balancing avec HaProxy ? (y/n) : " LOAD_BALANCING

    echo "[+] Ajout des règles iptables spécifiques au client"

    # DNAT vers client
    if ! iptables -t nat -C PREROUTING -i "$LAN_INTERFACE" -j DNAT --to-destination "$CLIENT_IP" &>/dev/null; then
        iptables -t nat -A PREROUTING -i "$LAN_INTERFACE" -j DNAT --to-destination "$CLIENT_IP"
    fi

    # MASQUERADE vers client
    if ! iptables -t nat -C POSTROUTING -d "$CLIENT_IP" -j MASQUERADE &>/dev/null; then
        iptables -t nat -A POSTROUTING -d "$CLIENT_IP" -j MASQUERADE
    fi

    # Cloisonnement
    if [ "$CLOISON" == "y" ]; then
        echo "[+] Ajout des règles de cloisonnement"
        iptables -A FORWARD -s "$CLIENT_IP" -d "$VPN_NETWORK" -j ACCEPT
        iptables -A FORWARD -s "$CLIENT_IP" -d 0.0.0.0/0 -j REJECT
    fi

    # Load balancing
    if [ "$LOAD_BALANCING" == "y" ]; then
        read -p "Entrez les ports à utiliser pour le load balancing (ex: 80,443) : " LOAD_BALANCING_PORTS
        IFS=',' read -ra PORTS <<< "$LOAD_BALANCING_PORTS"

        echo "[+] Configuration de HaProxy"
        for PORT in "${PORTS[@]}"; do
            cat <<EOF >> "$HA_PROXY_CONF"

frontend http_front_$PORT
    bind *:$PORT
    mode http
    default_backend http_back_$PORT

backend http_back_$PORT
    mode http
    balance roundrobin
    server $SERVER_TITLE $CLIENT_IP:$PORT check
EOF
        done
        systemctl restart haproxy
    fi

    save_iptables
}

read -p "Voulez-vous restaurer les règles iptables ou ajouter un serveur ? (restaurer/ajouter) : " ACTION

if [ "$ACTION" == "restaurer" ]; then
    restore_iptables
    echo "✅ Restauration des règles iptables terminée."
    exit 0
elif [ "$ACTION" == "ajouter" ]; then
    add_wireguard_client
    configure_iptables
    echo "✅ Serveur ajouté et configuration terminée."
else
    echo "[-] Action invalide. Veuillez entrer 'restaurer' ou 'ajouter'."
    exit 1
fi
