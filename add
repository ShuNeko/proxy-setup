#!/bin/bash

set -e

# -------- CONFIG --------
LAN_INTERFACE="eth0"
VPN_INTERFACE="wg0"
KEY_DIR="/etc/wireguard/keys"
WG_CONF="/etc/wireguard/${VPN_INTERFACE}.conf"
HA_PROXY_CONF="/etc/haproxy/haproxy.cfg"
IPTABLES_SAVE_PATH="/etc/iptables/rules.save"
VPN_NETWORK="192.168.5.0/24"
# ------------------------

# Fonction pour sauvegarder les règles iptables
save_iptables() {
    iptables-save > $IPTABLES_SAVE_PATH
}

# Fonction pour restaurer les règles iptables
restore_iptables() {
    if [ -f $IPTABLES_SAVE_PATH ]; then
        echo "[+] Restauration des règles iptables depuis $IPTABLES_SAVE_PATH"
        iptables-restore < $IPTABLES_SAVE_PATH
    else
        echo "[-] Fichier de sauvegarde des règles iptables non trouvé : $IPTABLES_SAVE_PATH"
    fi
}

# Fonction pour ajouter un client WireGuard
add_wireguard_client() {
    read -p "Entrez le titre du serveur : " SERVER_TITLE
    read -p "Entrez la clé publique du client : " CLIENT_PUB_KEY
    read -p "Entrez l'IP attribuée au client (ex: 192.168.5.2) : " CLIENT_IP

    echo "[+] Ajout du client WireGuard"
    systemctl stop wg-quick@$VPN_INTERFACE

    cat <<EOF >> $WG_CONF

# $SERVER_TITLE
[Peer]
PublicKey = $CLIENT_PUB_KEY
AllowedIPs = ${CLIENT_IP}/32
EOF

    systemctl start wg-quick@$VPN_INTERFACE
}

# Fonction pour ajouter une règle iptables si elle n'existe pas
add_iptables_rule() {
    local table=$1
    shift
    local rule=("$@")

    if ! iptables -t "$table" -C "${rule[@]}" 2>/dev/null; then
        iptables -t "$table" -A "${rule[@]}"
    fi
}

# Fonction pour configurer les règles iptables
configure_iptables() {
    read -p "Entrez à nouveau l'IP attribuée au client (ex: 192.168.5.2) : " CLIENT_IP
    read -p "Voulez-vous cloisonner le serveur ? (y/n) : " CLOISON
    read -p "Voulez-vous utiliser le load balancing avec HaProxy ? (y/n) : " LOAD_BALANCING

    echo "[+] Configuration des règles iptables"

    # Règle DNAT vers le client
    add_iptables_rule nat PREROUTING -i "$LAN_INTERFACE" -j DNAT --to-destination "$CLIENT_IP"

    # Masquerade pour retour
    add_iptables_rule nat POSTROUTING -d "$CLIENT_IP" -j MASQUERADE

    # Règle NAT générale (si pas déjà en place)
    add_iptables_rule nat POSTROUTING -s "$VPN_NETWORK" -o "$LAN_INTERFACE" -j MASQUERADE

    # Ports dangereux à autoriser explicitement si nécessaire
    for port in 22 23 3389; do
        add_iptables_rule nat PREROUTING -i "$LAN_INTERFACE" -p tcp --dport "$port" -j ACCEPT
    done

    # Cloisonnement
    if [ "$CLOISON" == "y" ]; then
        add_iptables_rule filter FORWARD -s "$CLIENT_IP" -d "$VPN_NETWORK" -j ACCEPT
        add_iptables_rule filter FORWARD -s "$CLIENT_IP" -d 0.0.0.0/0 -j REJECT
    fi

    # HAProxy
    if [ "$LOAD_BALANCING" == "y" ]; then
        read -p "Entrez les ports à utiliser pour le load balancing (séparés par des virgules, ex: 80,443) : " LOAD_BALANCING_PORTS

        echo "[+] Configuration de HaProxy pour le load balancing"

        IFS=',' read -r -a PORTS_ARRAY <<< "$LOAD_BALANCING_PORTS"
        for PORT in "${PORTS_ARRAY[@]}"; do
            if ! grep -q "frontend http_front_$PORT" "$HA_PROXY_CONF"; then
                cat <<EOF >> "$HA_PROXY_CONF"

frontend http_front_$PORT
    bind *:$PORT
    mode http
    default_backend http_back_$PORT

backend http_back_$PORT
    mode http
    balance roundrobin
    server server1 $CLIENT_IP:$PORT check
EOF
            fi
        done
        systemctl restart haproxy
    fi

    save_iptables
}

# Menu utilisateur
read -p "Voulez-vous restaurer les règles iptables ou ajouter un serveur ? (restaurer/ajouter) : " ACTION

if [ "$ACTION" == "restaurer" ]; then
    restore_iptables
    echo "✅ Restauration des règles iptables terminée."
    exit 0
elif [ "$ACTION" == "ajouter" ]; then
    add_wireguard_client
    configure_iptables
    echo "✅ Configuration terminée pour le serveur."
else
    echo "[-] Action invalide. Veuillez entrer 'restaurer' ou 'ajouter'."
    exit 1
fi
