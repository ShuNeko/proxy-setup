#!/bin/bash

set -e

# -------- CONFIG --------
LAN_INTERFACE="eth0"
LAN_STATIC_IP="192.168.1.24"
LAN_NETMASK="255.255.255.0"
LAN_GATEWAY="192.168.1.1"

VPN_INTERFACE="wg0"
VPN_SERVER_IP="192.168.5.55/24"
VPN_NETWORK="192.168.5.0/24"
VPN_PORT=51820
KEY_DIR="/etc/wireguard/keys"
WG_CONF="/etc/wireguard/${VPN_INTERFACE}.conf"
SCRIPT_PATH="$(realpath "$0")"

# Ports √† bloquer
BLOCKED_PORTS=(22 23 3389)
# ------------------------

echo "[+] Configuration de l‚Äôinterface LAN avec IP fixe : ${LAN_STATIC_IP}"
cat <<EOF > /etc/network/interfaces
auto lo
iface lo inet loopback

auto ${LAN_INTERFACE}
iface ${LAN_INTERFACE} inet static
    address ${LAN_STATIC_IP}
    netmask ${LAN_NETMASK}
    gateway ${LAN_GATEWAY}
EOF

echo "[+] Red√©marrage du r√©seau"
systemctl restart networking || true

echo "[+] Mise √† jour du syst√®me"
apt update && apt upgrade -y

echo "[+] Installation des paquets n√©cessaires"
apt install -y wireguard ufw fail2ban haproxy

echo "[+] Cr√©ation du dossier pour les cl√©s WireGuard"
mkdir -p ${KEY_DIR}
chmod 700 ${KEY_DIR}
cd ${KEY_DIR}

echo "[+] G√©n√©ration des cl√©s WireGuard (OpenCorePrivate/OpenCorePublic)"
umask 077
wg genkey | tee OpenCorePrivate.key | wg pubkey > OpenCorePublic.key

SERVER_PRIV_KEY=$(cat OpenCorePrivate.key)

echo "[+] R√©initialisation des r√®gles NAT (iptables -t nat -F)"
iptables -t nat -F

echo "[+] √âcriture de la configuration WireGuard : ${WG_CONF}"
cat <<EOF > ${WG_CONF}
[Interface]
Address = ${VPN_SERVER_IP}
ListenPort = ${VPN_PORT}
PrivateKey = ${SERVER_PRIV_KEY}
SaveConfig = true

PostUp = iptables -A FORWARD -i %i -j ACCEPT; \
         iptables -A FORWARD -o %i -j ACCEPT

PostDown = iptables -D FORWARD -i %i -j ACCEPT; \
           iptables -D FORWARD -o %i -j ACCEPT
EOF

chmod 600 ${WG_CONF}

echo "[+] Activation du routage IP dans /etc/sysctl.conf"
grep -q '^net.ipv4.ip_forward' /etc/sysctl.conf && \
    sed -i 's/^net.ipv4.ip_forward.*/net.ipv4.ip_forward=1/' /etc/sysctl.conf || \
    echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

echo "[+] Application imm√©diate du routage IP"
sysctl -w net.ipv4.ip_forward=1

echo "[+] Modification de /etc/default/ufw pour autoriser le forwarding"
sed -i 's/^DEFAULT_FORWARD_POLICY=.*/DEFAULT_FORWARD_POLICY="ACCEPT"/' /etc/default/ufw

echo "[+] D√©marrage et activation de WireGuard"
systemctl enable wg-quick@${VPN_INTERFACE}
systemctl start wg-quick@${VPN_INTERFACE}

echo "[+] Modification de /etc/ufw/before.rules pour ajouter NAT"
sed -i '/\*filter/i \
*nat\n\
:POSTROUTING ACCEPT [0:0]\n\
COMMIT\n' /etc/ufw/before.rules

echo "[+] Configuration du pare-feu avec UFW"
ufw --force disable
ufw default allow incoming
ufw default allow outgoing

echo "[+] Blocage des ports sensibles : ${BLOCKED_PORTS[*]}"
for port in "${BLOCKED_PORTS[@]}"; do
    ufw deny $port
done

ufw allow ${VPN_PORT}/udp comment 'WireGuard VPN'

echo "[+] R√©activation propre du pare-feu"
ufw --force enable

echo "[+] Red√©marrage de WireGuard pour appliquer tous les changements"
systemctl restart wg-quick@${VPN_INTERFACE}

echo "[+] fail2ban est d√©j√† install√©. V√©rifie /etc/fail2ban/jail.local pour personnaliser la protection."

echo ""
echo "‚úÖ INSTALLATION TERMIN√âE"
echo "Ton proxy WireGuard est pr√™t sur ${LAN_STATIC_IP}:${VPN_PORT}"
echo "IP WireGuard interne : ${VPN_SERVER_IP}"
echo "Fichier de config : ${WG_CONF}"
echo "Cl√©s stock√©es dans : ${KEY_DIR}"
echo ""
echo "‚ÑπÔ∏è Tu peux maintenant ajouter des clients WireGuard avec ./add.sh."
echo "üõë Pour supprim√© l'installation du Proxy utilise ./purge.sh."
echo ""

echo "[+] Suppression du script d'installation : ${SCRIPT_PATH}"
rm -f "${SCRIPT_PATH}"

