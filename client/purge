#!/bin/bash

set -e

SCRIPT_PATH="$(realpath "$0")"
WG_INTERFACE="wg0"
WG_CONFIG="/etc/wireguard/${WG_INTERFACE}.conf"
FRP_DIR="/opt/frp"
FRPC_SERVICE="/etc/systemd/system/frpc.service"

# === VÃ©rification des droits ===
if [ "$EUID" -ne 0 ]; then
  echo "Ce script doit Ãªtre exÃ©cutÃ© en root." >&2
  exit 1
fi

echo "[âš ï¸] Ce script va supprimer complÃ¨tement WireGuard et FRP du systÃ¨me."
read -p "Confirmer la purge complÃ¨te ? (oui/non) : " CONFIRM
if [[ "$CONFIRM" != "oui" ]]; then
  echo "[âœ‹] OpÃ©ration annulÃ©e."
  exit 0
fi

# === ArrÃªt des services ===
echo "[ğŸ›‘] ArrÃªt des services..."
systemctl stop frpc || true
systemctl stop wg-quick@$WG_INTERFACE || true

# === DÃ©sactivation des services ===
echo "[ğŸ§¹] DÃ©sactivation des services..."
systemctl disable frpc || true
systemctl disable wg-quick@$WG_INTERFACE || true

# === Suppression des fichiers ===
echo "[ğŸ§º] Suppression des fichiers de configuration et binaires..."
rm -rf "$FRP_DIR"
rm -f "$FRPC_SERVICE"
rm -f "$WG_CONFIG"
rm -f /etc/wireguard/privatekey /etc/wireguard/publickey

# === Reload systemd ===
systemctl daemon-reexec
systemctl daemon-reload

# === DÃ©sinstallation des paquets ===
echo "[ğŸ§½] Suppression des paquets installÃ©s (optionnel)..."
rm remove.sh
rm add.sh
rm -f "${SCRIPT_PATH}"
apt purge -y wireguard curl
apt autoremove -y

echo "[âœ…] Installation de l'installer."
wget -qO- https://raw.githubusercontent.com/ShuNeko/proxy-setup/refs/heads/main/client/setup> start.sh
chmod +x ./start.sh

echo ""
echo "[âœ…] Le client a Ã©tÃ© complÃ¨tement purgÃ©."
echo "[ğŸ’¡] Vous pouvez relancer le script dâ€™installation avec ./start.sh si besoin."
